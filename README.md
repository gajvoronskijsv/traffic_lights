<h1 class="code-line" data-line-start=0 data-line-end=1 ><a id="____0"></a>Адаптивный алгоритм работы светофоров</h1>
<p class="has-line-data" data-line-start="2" data-line-end="4">Абстракции светофоров и окружения сформированы так, чтобы соответствовать <a href="https://docs.yandex.ru/docs/view?url=ya-disk-public%3A%2F%2FoHjlRzVV3Vli6skj5jT4W1x8y7udgo%2ByccMra5WIF2WfPfWeehGtd3LRx4jkgpmiLnwuG65u%2BCaUWt4uUumLKA%3D%3D&amp;name=%D0%A2%D0%B5%D1%81%D1%82%D0%BE%D0%B2%D0%BE%D0%B5_%D0%B7%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5_%D0%B8%D0%BD%D0%B6%D0%B5%D0%BD%D0%B5%D1%80_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%81%D1%82.docx">тз</a>.<br>
Для запуска достаточно из корня проекта интерпретатором Python 3 выполнить команду:</p>
<pre><code>python -m traffic_lights
</code></pre>
<p class="has-line-data" data-line-start="7" data-line-end="8">Для настройки генератора доступны аргументы терминала, задающие верхний предел случайного генератора трафика для определенных светофоров:</p>
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>Аргумент</th>
<th>Значнеие (должно быть целым неотрицательным числом)</th>
</tr>
</thead>
<tbody>
<tr>
<td>-ct</td>
<td>трафик на верхнем автомобильном светофоре</td>
</tr>
<tr>
<td>-cr</td>
<td>трафик на правом автомобильном светофоре</td>
</tr>
<tr>
<td>-cb</td>
<td>трафик на нижнем автомобильном светофоре</td>
</tr>
<tr>
<td>-cl</td>
<td>трафик на левом автомобильном светофоре</td>
</tr>
<tr>
<td>-pt</td>
<td>трафик на светофорах верхнего пешеходного перехода</td>
</tr>
<tr>
<td>-pr</td>
<td>трафик на светофорах правого пешеходного перехода</td>
</tr>
<tr>
<td>-pb</td>
<td>трафик на светофорах нижнего пешеходного перехода</td>
</tr>
<tr>
<td>-pl</td>
<td>трафик на светофорах левого пешеходного перехода</td>
</tr>
</tbody>
</table>
<p class="has-line-data" data-line-start="20" data-line-end="22">По умолчанию значение каждого параметра равно 5.<br>
К примеру, для того чтобы убрать весь трафик на горизонтальной дороге и верхнем и нижнем пешеходных переходах, а также добавить трафика для движения по дороге сверху вниз и на левом пешеходном переходе, потребуется команда:</p>
<pre><code>python -m traffic_lights -cl 0 -cr 0 -pt 0 -pb 0 -cb 10 -pl 10
</code></pre>
<h4 class="code-line" data-line-start=28 data-line-end=29 ><a id="__28"></a>Описание алгоритма</h4>
<ul>
<li class="has-line-data" data-line-start="30" data-line-end="31">Перекресток, симулируемый классом Crossroad, создает светофоры и запускает генерацию трафика. С периодичностью в 5 секунд в консоль выводится текущее состояние перекрестка до и после работы светофоров Позиция пары значений (g/r)(N) соответствует позициям светофоров на иллюстрации к тз, где g - зеленый свет, r - красный свет, N - величина трафика, который видит камера перед светофором.</li>
<li class="has-line-data" data-line-start="31" data-line-end="32">Алгоритм может использовать произвольное количество схем движения на перекрестке, описываемых классом MovementScheme.</li>
<li class="has-line-data" data-line-start="32" data-line-end="34">Каждый светофор описывается классом TrafficLight и работает асинхронно. Светофор общается с остальными светофорами на перекрестке сообщениями (класс Event), которые передаются средой (классом Crossroad). Светофоры знают какие схемы движения есть на перекрестке и в каких он участвует. За счет совместного выбора схемы, светофоры решают, какое состояние они примут в следующую очередь.</li>
</ul>
<p class="has-line-data" data-line-start="34" data-line-end="35">Цикл работы светофора в рамках схемы движения следующий:</p>
<ul>
<li class="has-line-data" data-line-start="36" data-line-end="37">Светофор отправляет свой Event остальным и ожидает, пока остальные светофоры также пришлют свой Event. В этом сообщении указывается, голосует ли данный светофор за схему движения в данный момент (“vote”), или уступает остальным светофорам на перекрестке (“pass”). Также в сообщении указывается величина очереди с камеры светофора.</li>
<li class="has-line-data" data-line-start="37" data-line-end="38">Получив все Event, светофор подставляет данные из них в схемы движения на перекрестке, формируя рейтинг схемы. Положительная часть рейтинга формируется из суммарной загрузки всех светофоров, которые включат зеленый свет при работе этой схемы (то есть отражает то, сколько единиц транспорта и людей схема может пропустить), но только если светофор в сообщении не указывает, что уступает остальным. Отрицательная часть рейтинга формируется из суммарной загрузки всех светофоров, которые включат красный, также при условии, что эти светофоры не уступают остальным.</li>
<li class="has-line-data" data-line-start="38" data-line-end="39">Получив все рейтинги схем, светофор проверяет, не уступают ли все светофоры на перекрестке одновременно. Это может означать, что каждый светофор уже пропустил свой трафик и нужно сбросить очередь. Также это может означать, что ни у одного светофора нет трафика на камере. Если все светофоры уступают, то светофор решает, хочет ли он включаться, в зависимости от трафика на своей камере, и заново отсылает свой Event на голосование.</li>
<li class="has-line-data" data-line-start="39" data-line-end="41">Если не все светофоры уступают и произошел выбор лучшей схемы, светофор переключает свое состояние, чтобы соответствовать схеме. Если светофор включил зеленый свет, то значит что он пропустит свой трафик и начнет уступать другим светофорам, отправив в следующем сообщении “pass”. Следующее сообщение, которое инициирует очередной цикл голосования, он отправит с задержкой в 5 секунд.</li>
</ul>
<h4 class="code-line" data-line-start=41 data-line-end=42 ><a id="__41"></a>Преимущества алгоритма</h4>
<ul>
<li class="has-line-data" data-line-start="43" data-line-end="44">Если нет трафика перед светофором, он не будет влиять на оптимальную схему движения.</li>
<li class="has-line-data" data-line-start="44" data-line-end="45">Если трафик есть, то победит та схема, которая в теории пропустит за цикл больше единиц транспорта и людей.</li>
<li class="has-line-data" data-line-start="45" data-line-end="46">При этом исключена ситуация, когда светофоры зациклятся между двумя самыми нагруженными трафиком схемами, благодаря системе уступок. Гарантровано, что каждый участник движения дождется своей очереди.</li>
<li class="has-line-data" data-line-start="46" data-line-end="48">Можно добавить любое количество схем движения.</li>
</ul>
<h4 class="code-line" data-line-start=48 data-line-end=49 ><a id="_______48"></a>Что можно улучшить после отправки рабочей версии</h4>
<ul>
<li class="has-line-data" data-line-start="50" data-line-end="51">Лучше структурировать/закоментровать код. (сделано)</li>
<li class="has-line-data" data-line-start="51" data-line-end="52">Расширить функционал генератора трафика и протестировать экзотические сценарии. (сделано, кроме того добавлен нормальный консольный интерфейс с возможностью настройки генератора через передачу аргументов в терминале)</li>
<li class="has-line-data" data-line-start="52" data-line-end="53">Симулировать время переключения с желтого на красный</li>
<li class="has-line-data" data-line-start="53" data-line-end="54">Добавить время для очистки перекрестка перед включением следующей схемы</li>
<li class="has-line-data" data-line-start="54" data-line-end="56">Добавить динамическое изменение времени работы светофоров в выбранной схеме в зависимости от трафика</li>
</ul>